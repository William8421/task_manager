<div class="tasks-container">
    <div class="backdrop" *ngIf="showCreateModal || showUpdateModal || showDeleteModal" (click)="closeBackdrop()"></div>
    <h1>My tasks</h1>
    <p class="response-message" *ngIf="responseMessage">{{ responseMessage }}</p>
    <div class="tasks" *ngIf="isLoggedIn; else loginMessage">
        <button class="main-button" (click)="toggleCreateModal()">New task</button>
        <div class="filter-search-container">
            <span class="filter-search-button" (click)="toggleSearchMode()">{{searchMode? 'Filter tasks' :
                'Search tasks'}}</span>
            <div class="form-container" *ngIf="!searchMode">
                <form #selectFilter="ngForm" (change)="filterTasksByStatus(selectFilter)">
                    <label for="statusFilter">Filter tasks:</label>
                    <select id="statusFilter" name="status" ngModel>
                        <option value="all">All</option>
                        <option value="Completed">Completed</option>
                        <option value="Pending">Pending</option>
                        <option value="In progress">In Progress</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </form>
            </div>
            <div class="form-container" *ngIf="searchMode">
                <form #searchQuery="ngForm" (submit)="searchTasksByTitle(searchQuery)">
                    <div>
                        <input type="search" id="searchTasks" name="title" ngModel>
                        <i class="fa-solid fa-magnifying-glass" (click)="searchTasksByTitle(searchQuery)"></i>
                    </div>
                    <div *ngIf="errorMessage">{{errorMessage}}</div>
                </form>
            </div>
        </div>
        <div class="task" *ngFor="let task of tasks">
            <div class="task-body" [class.canceled]="isTaskCancelled(task)">
                <div class="task-header" [class.completed]="isTaskCompleted(task)"
                    [class.overdue]="isTaskOverdue(task)">
                    <p class="title" (click)="showMoreDetails(task)">
                        {{task.title}}
                    </p>
                    <div class="action-icons-container">
                        <div class="arrows-container">
                            <i (click)="showMoreDetails(task)"
                                [class]="moreLessTask === task? 'fa-solid fa-angles-up' : 'fa-solid fa-angles-down'"></i>
                        </div>
                        <div class="arrows-container-large">
                            <i (click)="showMoreDetails(task)"
                                [class]="moreLessTask === task? 'fa-solid fa-angles-left' : 'fa-solid fa-angles-right'"></i>
                        </div>
                        <i class="fa-solid fa-trash-can" (click)="toggleDeleteModal(task)"></i>
                        <i class="fa-solid fa-pen" (click)="toggleUpdateModal(task)"></i>
                    </div>
                </div>
                <div class="more-information" *ngIf=" moreLessTask === task">
                    <div class="more-information-body">
                        <p class="title"><strong>{{task.title}}</strong>
                        </p>
                        <p class="description"><strong>Description: </strong> <span>{{task.description}} </span></p>
                        <p><strong>Status: </strong> <span>{{task.status}} </span></p>
                        <p [class.overdue]="isTaskOverdue(task)"><strong>Due Date: </strong> <span>{{task.due_date |
                                date:
                                'dd.MM.yyyy HH:mm'}}
                            </span></p>
                        <p><strong>Created at: </strong> <span>{{task.created_at | date: 'dd.MM.yyyy HH:mm':'UTC+0400'}}
                            </span>
                        </p>
                        <p *ngIf="task.updated_at"><strong>Updated at: </strong> <span>
                                {{task.updated_at | date: 'dd.MM.yyyy HH:mm':'UTC+0400'}} </span> </p>
                    </div>
                    <div class="action-buttons-container">
                        <button class="delete-button" (click)="toggleDeleteModal(task)">Delete</button>
                        <button class="main-button" (click)="toggleUpdateModal(task)">Update</button>
                    </div>
                    <div class="arrows-container">
                        <i (click)="showMoreDetails(task)"
                            [class]="moreLessTask === task? 'fa-solid fa-angles-up' : 'fa-solid fa-angles-down'"></i>
                    </div>
                </div>
            </div>
            <app-update-task-modal *ngIf="showUpdateModal" [task]="selectedTask"
                (responseMessage)="handleResponseMessageChange($event)" (toggleUpdateModal)="toggleUpdateModal(task)"
                (refreshTasks)="getUserTasks()">
            </app-update-task-modal>
            <app-delete-task-modal *ngIf="showDeleteModal" [task]="selectedTask"
                (responseMessage)="handleResponseMessageChange($event)" (toggleDeleteModal)="toggleDeleteModal(task)"
                (refreshTasks)="getUserTasks()">
            </app-delete-task-modal>
        </div>
    </div>
    <ng-template #loginMessage>
        <p>Please <span class="redirect" (click)="redirectToLogin()">Login</span> to see your tasks</p>
    </ng-template>
    <app-create-task-modal *ngIf="showCreateModal" (toggleCreateModal)="toggleCreateModal()"
        (responseMessage)="handleResponseMessageChange($event)" (refreshTasks)="getUserTasks()">
    </app-create-task-modal>
</div>